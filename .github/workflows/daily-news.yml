name: Daily Hindi News Fetcher

on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  fetch-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ” Debug - List files
      run: |
        echo "=== Current Directory ==="
        pwd
        echo "=== Files in Repository ==="
        ls -la
        echo "=== Looking for JS files ==="
        find . -name "*.js" | head -10

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“¦ Install Puppeteer
      run: npm install puppeteer@latest --no-package-lock

    - name: ğŸ” Check and Create Script
      run: |
        if [ -f "news-script.js" ]; then
          echo "âœ… news-script.js found!"
          echo "First 5 lines:"
          head -5 news-script.js
        else
          echo "âŒ news-script.js not found - creating it now"
          cat > news-script.js << 'EOF'
const puppeteer = require('puppeteer');
const fs = require('fs');

(async () => {
  console.log('ğŸš€ Starting ChatGPT news automation...');
  
  try {
    const browser = await puppeteer.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-accelerated-2d-canvas',
        '--no-first-run',
        '--no-zygote',
        '--disable-gpu'
      ]
    });

    const page = await browser.newPage();
    
    console.log('ğŸŒ Navigating to ChatGPT...');
    await page.goto('https://chat.openai.com', { 
      waitUntil: 'networkidle2',
      timeout: 60000 
    });

    console.log('â³ Waiting for page to load...');
    await page.waitForSelector('#prompt-textarea', { 
      visible: true,
      timeout: 30000 
    });

    const message = 'Give today\'s current affairs news in Hindi in JSON format with at least 5 news items. Always return valid JSON format.';
    
    console.log('âŒ¨ï¸ Typing message...');
    await page.type('#prompt-textarea', message, { delay: 30 });
    
    console.log('ğŸ“¤ Sending message...');
    await page.click('#composer-submit-button');
    
    console.log('â³ Waiting for response (up to 3 minutes)...');
    
    let jsonText = null;
    let attempts = 0;
    const maxAttempts = 60;
    
    while (attempts < maxAttempts && !jsonText) {
      attempts++;
      
      jsonText = await page.evaluate(() => {
        const codeBlocks = document.querySelectorAll('code');
        for (const block of codeBlocks) {
          const text = block.textContent.trim();
          if ((text.startsWith('{') && text.endsWith('}')) || 
              (text.startsWith('[') && text.endsWith(']'))) {
            return text;
          }
        }
        return null;
      });
      
      if (!jsonText) {
        console.log("Waiting... attempt $attempts/$maxAttempts");
        await new Promise(resolve => setTimeout(resolve, 3000));
      }
    }

    if (jsonText) {
      console.log('âœ… JSON found!');
      try {
        const cleanedJson = jsonText.replace(/```json|```/g, '').trim();
        const jsonData = JSON.parse(cleanedJson);
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = "news-${timestamp}.json";
        
        fs.writeFileSync(filename, JSON.stringify(jsonData, null, 2));
        console.log("ğŸ’¾ Saved as: $filename");
        
        fs.writeFileSync('latest-news.json', JSON.stringify({
          timestamp: new Date().toISOString(),
          data: jsonData
        }, null, 2));
        
        console.log('ğŸ“„ Latest news saved!');
        
      } catch (parseError) {
        console.error('âŒ JSON parsing failed');
        fs.writeFileSync('raw-response.txt', jsonText);
      }
    } else {
      console.error('âŒ No JSON response found');
      await page.screenshot({ path: 'debug-screenshot.png' });
    }

    await browser.close();
    console.log('ğŸ‰ Process completed!');
    
  } catch (error) {
    console.error('ğŸ’¥ Critical error:', error);
    process.exit(1);
  }
})();
EOF
          echo "âœ… news-script.js created successfully!"
        fi

    - name: ğŸš€ Run news script
      run: node news-script.js
      timeout-minutes: 10

    - name: ğŸ“¤ Upload results
      uses: actions/upload-artifact@v4
      with:
        name: news-results
        path: |
          *.json
          *.txt
          *.png
        retention-days: 7

    - name: ğŸ“Š Show final files
      run: ls -la